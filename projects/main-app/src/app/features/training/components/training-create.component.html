<div class="training-create">
  <div class="form-header">
    <h2>Cr√©er une nouvelle formation</h2>
    <button type="button" class="btn-close" (click)="onCancel()">‚úï</button>
  </div>

  <form [formGroup]="trainingForm" (ngSubmit)="onSubmit()">
    <!-- Training Info -->
    <div class="section">
      <h3>Informations g√©n√©rales</h3>

      <div class="form-group">
        <label for="title">Titre *</label>
        <input
          id="title"
          type="text"
          formControlName="title"
          placeholder="Ex: Angular Fundamentals"
        />
        @if (trainingForm.get('title')?.invalid && trainingForm.get('title')?.touched) {
          <span class="field-error">Le titre est obligatoire (min. 3 caract√®res)</span>
        }
      </div>

      <div class="form-group">
        <label for="description">Description *</label>
        <textarea
          id="description"
          formControlName="description"
          rows="4"
          placeholder="Description de la formation..."
        ></textarea>
        @if (trainingForm.get('description')?.invalid && trainingForm.get('description')?.touched) {
          <span class="field-error">La description est obligatoire (min. 10 caract√®res)</span>
        }
      </div>

      <div class="form-group">
        <label>Vid√©o d'introduction (optionnelle)</label>
        <app-video-input
          (videoChange)="onTrainingVideoSelected($event)"
        ></app-video-input>
      </div>
    </div>

    <!-- Quests Section -->
    <div class="section" formArrayName="quests">
      <div class="section-header">
        <h3>Qu√™tes</h3>
        <button type="button" class="btn-primary btn-small" (click)="addQuest()">
          + Ajouter une qu√™te
        </button>
      </div>

      @for (questControl of questsArray.controls; track $index) {
        <div class="quest-card" [formGroupName]="$index">
          <div class="quest-header">
            <h4>Qu√™te {{ $index + 1 }}</h4>
            <button type="button" class="btn-icon btn-danger" (click)="removeQuest($index)">
              üóëÔ∏è
            </button>
          </div>

          <div class="form-group">
            <label>Titre de la qu√™te *</label>
            <input
              type="text"
              formControlName="title"
              placeholder="Ex: D√©couvrir les composants"
            />
            @if (questControl.get('title')?.invalid && questControl.get('title')?.touched) {
              <span class="field-error">Le titre est obligatoire (min. 3 caract√®res)</span>
            }
          </div>

          <div class="form-group">
            <label>Description de la qu√™te *</label>
            <textarea
              formControlName="description"
              rows="3"
              placeholder="Description de la qu√™te..."
            ></textarea>
            @if (questControl.get('description')?.invalid && questControl.get('description')?.touched) {
              <span class="field-error">La description est obligatoire (min. 10 caract√®res)</span>
            }
          </div>

          <div class="form-group">
            <label>Vid√©o de la qu√™te (optionnelle)</label>
            <app-video-input
              (videoChange)="onQuestVideoSelected($index, $event)"
            ></app-video-input>
          </div>

          <!-- Objectives for this quest -->
          <div class="objectives-section" [formArrayName]="'objectives'">
            <div class="objectives-header">
              <h5>Objectifs de la qu√™te</h5>
              <button type="button" class="btn-secondary btn-small" (click)="addObjective($index)">
                + Ajouter un objectif
              </button>
            </div>

            @for (objectiveControl of getObjectivesArray($index).controls; track $index) {
              <div class="objective-card" [formGroupName]="$index">
                <div class="objective-header">
                  <span>Objectif {{ $index + 1 }}</span>
                  <button type="button" class="btn-icon btn-danger-small" (click)="removeObjective(questControl, $index)">
                    ‚úï
                  </button>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Titre *</label>
                    <input
                      type="text"
                      formControlName="title"
                      placeholder="Ex: Cr√©er un composant"
                    />
                    @if (objectiveControl.get('title')?.invalid && objectiveControl.get('title')?.touched) {
                      <span class="field-error">Le titre est obligatoire (min. 3 caract√®res)</span>
                    }
                  </div>

                  <div class="form-group form-group-small">
                    <label>Points *</label>
                    <input
                      type="number"
                      formControlName="points"
                      min="1"
                    />
                    @if (objectiveControl.get('points')?.invalid && objectiveControl.get('points')?.touched) {
                      <span class="field-error">Min. 1 point</span>
                    }
                  </div>
                </div>

                <div class="form-group">
                  <label>Description *</label>
                  <textarea
                    formControlName="description"
                    rows="2"
                    placeholder="Description de l'objectif..."
                  ></textarea>
                  @if (objectiveControl.get('description')?.invalid && objectiveControl.get('description')?.touched) {
                    <span class="field-error">La description est obligatoire (min. 10 caract√®res)</span>
                  }
                </div>

                <div class="form-group">
                  <label>Vid√©o de l'objectif (optionnelle)</label>
                  <app-video-input
                    (videoChange)="onObjectiveVideoSelected(questControl, $index, $event)"
                  ></app-video-input>
                </div>
              </div>
            } @empty {
              <div class="empty-objectives">
                Aucun objectif. Cliquez sur "Ajouter un objectif" pour commencer.
              </div>
            }
          </div>
        </div>
      } @empty {
        <div class="empty-quests">
          Aucune qu√™te. Cliquez sur "Ajouter une qu√™te" pour commencer.
        </div>
      }
    </div>

    @if (errorMessage()) {
      <div class="error-message">
        {{ errorMessage() }}
      </div>
    }

    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="onCancel()">
        Annuler
      </button>
      <button
        type="submit"
        class="btn-primary"
        [disabled]="trainingForm.invalid || isSubmitting()"
      >
        {{ isSubmitting() ? 'Cr√©ation...' : 'Cr√©er la formation' }}
      </button>
    </div>
  </form>
</div>
